<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planning 8 joueurs - Doubles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #111827;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
    }
    .app {
      background: #ffffff;
      max-width: 1000px;
      width: 100%;
      padding: 24px 24px 32px;
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.08);
    }
    h1 {
      font-size: 1.6rem;
      margin: 0 0 4px;
    }
    h2 {
      font-size: 1.3rem;
      margin: 24px 0 6px;
    }
    .subtitle {
      margin: 0 0 20px;
      font-size: 0.9rem;
      color: #6b7280;
    }
    .subtitle-small {
      margin: 0 0 10px;
      font-size: 0.8rem;
      color: #6b7280;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.5fr) minmax(0, 1.5fr);
      gap: 24px;
      align-items: flex-start;
    }
    .inputs-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 12px;
    }
    label {
      font-size: 0.8rem;
      color: #4b5563;
      display: block;
      margin-bottom: 3px;
    }
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }
    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0 18px;
      flex-wrap: wrap;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.3);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
    }
    button:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.35);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.25);
    }
    .hint {
      font-size: 0.8rem;
      color: #6b7280;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    thead {
      background: #eff2ff;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: normal;
    }

    .round-cell {
      font-weight: 600;
      white-space: nowrap;
      text-align: center;
    }
    .court-cell {
      color: #4b5563;
      white-space: nowrap;
      text-align: center;
    }
    .team-cell {
      font-weight: 500;
    }
    .score-cell {
      text-align: center;
      white-space: nowrap;
    }
    .score-input {
      width: 60px;
      box-sizing: border-box;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
      text-align: center;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .score-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }

    .ranking-table th,
    .ranking-table td {
      font-size: 0.85rem;
    }
    .rank-cell {
      font-weight: 700;
      width: 60px;
    }
    .player-name-cell {
      font-weight: 600;
    }
    .points-cell {
      font-weight: 700;
      text-align: right;
      width: 70px;
    }

    .rank-row-1 { background: #fef9c3; }
    .rank-row-2 { background: #e5e7eb; }
    .rank-row-3 { background: #fee2e2; }

    /* Couleurs par tour */
    .round-row-0 { background: #fefce8; }
    .round-row-1 { background: #eff6ff; }
    .round-row-2 { background: #ecfdf5; }
    .round-row-3 { background: #fdf2f8; }
    .round-row-4 { background: #eef2ff; }
    .round-row-5 { background: #f1f5f9; }
    .round-row-6 { background: #fff7ed; }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* QR code */
    .share-box {
      margin-top: 24px;
      padding-top: 12px;
      border-top: 1px dashed #e5e7eb;
      text-align: center;
    }
    .qr-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .qr-subtitle {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .qr-wrapper img {
      max-width: 160px;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    @media (max-width: 800px) {
      .inputs-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      th, td {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Planning de doubles pour 8 joueurs</h1>
    <p class="subtitle">
      Saisis les noms des 8 joueurs, puis le planning se g√©n√®re automatiquement.
      Chaque paire joue <strong>une seule fois ensemble</strong>.
      Tu peux ensuite saisir les <strong>scores</strong> pour voir le classement.
      <br />Les points du classement = <strong>total des points marqu√©s</strong> par chaque joueur.
    </p>

    <div class="inputs-grid" id="players-inputs">
      <div>
        <label for="p0">Joueur 1</label>
        <input id="p0" type="text" placeholder="Joueur 1" />
      </div>
      <div>
        <label for="p1">Joueur 2</label>
        <input id="p1" type="text" placeholder="Joueur 2" />
      </div>
      <div>
        <label for="p2">Joueur 3</label>
        <input id="p2" type="text" placeholder="Joueur 3" />
      </div>
      <div>
        <label for="p3">Joueur 4</label>
        <input id="p3" type="text" placeholder="Joueur 4" />
      </div>
      <div>
        <label for="p4">Joueur 5</label>
        <input id="p4" type="text" placeholder="Joueur 5" />
      </div>
      <div>
        <label for="p5">Joueur 6</label>
        <input id="p5" type="text" placeholder="Joueur 6" />
      </div>
      <div>
        <label for="p6">Joueur 7</label>
        <input id="p6" type="text" placeholder="Joueur 7" />
      </div>
      <div>
        <label for="p7">Joueur 8</label>
        <input id="p7" type="text" placeholder="Joueur 8" />
      </div>
    </div>

    <div class="actions">
      <button id="generate-btn">
        üîÅ R√©initialiser noms & scores
      </button>
      <span class="hint">
        Ce bouton remet <strong>tous les noms</strong> et <strong>tous les scores</strong> √† z√©ro pour tout le monde.
      </span>
    </div>

    <div class="layout">
      <!-- PLANNING + SCORES -->
      <div>
        <h2>Planning & scores</h2>
        <p class="subtitle-small">
          Entre un score sur les deux colonnes (Score A et Score B) pour chaque match.
        </p>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Tour</th>
                <th>Terrain</th>
                <th>√âquipe A</th>
                <th>√âquipe B</th>
                <th>Score A</th>
                <th>Score B</th>
              </tr>
            </thead>
            <tbody id="schedule-body"></tbody>
          </table>
        </div>
      </div>

      <!-- CLASSEMENT + PARTAGE -->
      <div>
        <h2>Classement</h2>
        <p class="subtitle-small">
          Classement tri√© sur le <strong>total des points marqu√©s</strong>.
        </p>
        <div class="table-wrapper">
          <table class="ranking-table">
            <thead>
              <tr>
                <th>Rang</th>
                <th>Joueur</th>
                <th>Points</th>
              </tr>
            </thead>
            <tbody id="ranking-body"></tbody>
          </table>
        </div>

        <div class="share-box">
          <div class="qr-title">Partager le tournoi</div>
          <div class="qr-subtitle">
            Scanne le QR code pour ouvrir<br />americano.walton.fr
          </div>
          <div class="qr-wrapper">
            <img
              src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https%3A%2F%2Famericano.walton.fr"
              alt="QR code vers americano.walton.fr"
            />
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // üëâ URL de ton Web Service Flask (API scores)
    const API_BASE = "https://walton-holidays-1.onrender.com";

    const rounds = [
  [
    { court: 1, teamA: [0, 1], teamB: [2, 3] },
    { court: 2, teamA: [4, 5], teamB: [6, 7] },
  ],
  [
    { court: 1, teamA: [0, 2], teamB: [1, 3] },
    { court: 2, teamA: [4, 6], teamB: [5, 7] },
  ],
  [
    { court: 1, teamA: [0, 3], teamB: [4, 7] },
    { court: 2, teamA: [1, 2], teamB: [5, 6] },
  ],
  [
    { court: 1, teamA: [0, 4], teamB: [1, 5] },
    { court: 2, teamA: [2, 6], teamB: [3, 7] },
  ],
  [
    { court: 1, teamA: [0, 5], teamB: [2, 7] },
    { court: 2, teamA: [1, 4], teamB: [3, 6] },
  ],
  [
    { court: 1, teamA: [0, 6], teamB: [2, 4] },
    { court: 2, teamA: [1, 7], teamB: [3, 5] },
  ],
  [
    { court: 1, teamA: [0, 7], teamB: [1, 6] },
    { court: 2, teamA: [2, 5], teamB: [3, 4] },
  ],
];


    let scores = {};
    let remotePlayers = [];

    function scoreKey(roundIndex, matchIndex, team) {
      return `${roundIndex}-${matchIndex}-${team}`;
    }

    function getPlayerNames() {
      const names = [];
      for (let i = 0; i < 8; i++) {
        const input = document.getElementById("p" + i);
        const value = input.value.trim();
        names.push(value || `Joueur ${i + 1}`);
      }
      return names;
    }

    async function loadFromServer() {
      try {
        const res = await fetch(`${API_BASE}/scores`, { cache: "no-store" });
        if (!res.ok) return;
        const data = await res.json();
        scores = data.scores || {};
        remotePlayers = Array.isArray(data.players) ? data.players : [];

        if (remotePlayers.length === 8) {
          remotePlayers.forEach((name, i) => {
            const input = document.getElementById("p" + i);
            if (input) input.value = name;
          });
        }
      } catch (e) {
        console.warn("Impossible de charger les scores distants", e);
      }
    }

    async function saveToServer() {
      const payload = {
        scores,
        players: getPlayerNames(),
      };
      try {
        await fetch(`${API_BASE}/scores`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      } catch (e) {
        console.warn("Impossible d'enregistrer les scores distants", e);
      }
    }

    function updateStandings() {
      const names = getPlayerNames();

      const stats = names.map((name) => ({
        name,
        pointsFor: 0,
        pointsAgainst: 0,
        diff: 0,
      }));

      rounds.forEach((round, roundIndex) => {
        round.forEach((match, matchIndex) => {
          const keyA = scoreKey(roundIndex, matchIndex, "A");
          const keyB = scoreKey(roundIndex, matchIndex, "B");
          const a = scores[keyA];
          const b = scores[keyB];

          if (typeof a !== "number" || typeof b !== "number") return;

          match.teamA.forEach((playerIndex) => {
            stats[playerIndex].pointsFor += a;
            stats[playerIndex].pointsAgainst += b;
          });
          match.teamB.forEach((playerIndex) => {
            stats[playerIndex].pointsFor += b;
            stats[playerIndex].pointsAgainst += a;
          });
        });
      });

      stats.forEach((s) => {
        s.diff = s.pointsFor - s.pointsAgainst;
      });

      const sorted = [...stats].sort((a, b) => {
        if (b.pointsFor !== a.pointsFor) return b.pointsFor - a.pointsFor;
        if (b.diff !== a.diff) return b.diff - a.diff;
        return a.name.localeCompare(b.name, "fr");
      });

      const rankingBody = document.getElementById("ranking-body");
      rankingBody.innerHTML = "";

      sorted.forEach((player, index) => {
        const tr = document.createElement("tr");

        if (index === 0) tr.classList.add("rank-row-1");
        if (index === 1) tr.classList.add("rank-row-2");
        if (index === 2) tr.classList.add("rank-row-3");

        const rankTd = document.createElement("td");
        rankTd.className = "rank-cell";
        rankTd.textContent = index + 1;
        tr.appendChild(rankTd);

        const nameTd = document.createElement("td");
        nameTd.className = "player-name-cell";
        nameTd.textContent = player.name;
        tr.appendChild(nameTd);

        const ptsTd = document.createElement("td");
        ptsTd.className = "points-cell";
        ptsTd.textContent = player.pointsFor;
        tr.appendChild(ptsTd);

        rankingBody.appendChild(tr);
      });
    }

    function onScoreChange(e) {
      const input = e.target;
      const r = input.getAttribute("data-round-index");
      const m = input.getAttribute("data-match-index");
      const t = input.getAttribute("data-team");
      const key = scoreKey(r, m, t);

      if (input.value === "") {
        delete scores[key];
      } else {
        const val = parseInt(input.value, 10);
        if (Number.isNaN(val)) {
          delete scores[key];
        } else {
          scores[key] = val;
        }
      }
      updateStandings();
      saveToServer();
    }

    function attachScoreListeners(input) {
      ["input", "change", "keyup"].forEach((evt) => {
        input.addEventListener(evt, onScoreChange);
      });
    }

    function renderSchedule() {
      const names = getPlayerNames();
      const tbody = document.getElementById("schedule-body");
      tbody.innerHTML = "";

      rounds.forEach((round, roundIndex) => {
        round.forEach((match, matchIndex) => {
          const tr = document.createElement("tr");
          tr.classList.add(`round-row-${roundIndex}`);

          if (matchIndex === 0) {
            const roundTd = document.createElement("td");
            roundTd.className = "round-cell";
            roundTd.rowSpan = round.length;
            roundTd.textContent = "Tour " + (roundIndex + 1);
            tr.appendChild(roundTd);
          }

          const courtTd = document.createElement("td");
          courtTd.className = "court-cell";
          courtTd.textContent = "Terrain " + match.court;
          tr.appendChild(courtTd);

          const teamATd = document.createElement("td");
          const teamBTd = document.createElement("td");
          teamATd.className = "team-cell";
          teamBTd.className = "team-cell";

          teamATd.textContent =
            names[match.teamA[0]] + " & " + names[match.teamA[1]];
          teamBTd.textContent =
            names[match.teamB[0]] + " & " + names[match.teamB[1]];

          tr.appendChild(teamATd);
          tr.appendChild(teamBTd);

          const scoreATd = document.createElement("td");
          const scoreBTd = document.createElement("td");
          scoreATd.className = "score-cell";
          scoreBTd.className = "score-cell";

          const scoreAInput = document.createElement("input");
          scoreAInput.type = "number";
          scoreAInput.min = "0";
          scoreAInput.className = "score-input";
          scoreAInput.placeholder = "0";
          scoreAInput.setAttribute("data-round-index", roundIndex);
          scoreAInput.setAttribute("data-match-index", matchIndex);
          scoreAInput.setAttribute("data-team", "A");

          const scoreBInput = document.createElement("input");
          scoreBInput.type = "number";
          scoreBInput.min = "0";
          scoreBInput.className = "score-input";
          scoreBInput.placeholder = "0";
          scoreBInput.setAttribute("data-round-index", roundIndex);
          scoreBInput.setAttribute("data-match-index", matchIndex);
          scoreBInput.setAttribute("data-team", "B");

          const keyA = scoreKey(roundIndex, matchIndex, "A");
          const keyB = scoreKey(roundIndex, matchIndex, "B");
          if (typeof scores[keyA] === "number") {
            scoreAInput.value = scores[keyA];
          }
          if (typeof scores[keyB] === "number") {
            scoreBInput.value = scores[keyB];
          }

          attachScoreListeners(scoreAInput);
          attachScoreListeners(scoreBInput);

          scoreATd.appendChild(scoreAInput);
          scoreBTd.appendChild(scoreBInput);

          tr.appendChild(scoreATd);
          tr.appendChild(scoreBTd);

          tbody.appendChild(tr);
        });
      });

      updateStandings();
    }

    // Bouton : avertissement + reset complet noms + scores
    document.getElementById("generate-btn").addEventListener("click", (e) => {
      e.preventDefault();
      const ok = confirm(
        "‚ö†Ô∏è ATTENTION : ceci va remettre √† z√©ro TOUS les noms et TOUS les scores pour tout le monde.\n\nEs-tu s√ªr de vouloir r√©initialiser le tournoi ?"
      );
      if (!ok) return;

      scores = {};

      for (let i = 0; i < 8; i++) {
        const input = document.getElementById("p" + i);
        if (input) input.value = "";
      }

      saveToServer();
      renderSchedule();
    });

    // Quand on change un nom, on r√©g√©n√®re le planning et on sauvegarde les noms
    for (let i = 0; i < 8; i++) {
      document
        .getElementById("p" + i)
        .addEventListener("input", () => {
          renderSchedule();
          saveToServer();
        });
    }

    // Initialisation : charger depuis le serveur puis construire la page
    (async () => {
      await loadFromServer();
      renderSchedule();
    })();

    // üì≤ Enregistrement du Service Worker pour la PWA
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/sw.js")
          .catch((err) => console.warn("SW registration failed", err));
      });
    }
  </script>
</body>
</html>
